name: Start GotoHTTP on Windows

on:
  workflow_dispatch:

jobs:
  run-gotohttp:
    runs-on: windows-latest

    steps:
    - name: 下载 GotoHTTP zip 包
      run: |
        Invoke-WebRequest -Uri "https://www.gotohttp.com/gotohttp_x64.zip" -OutFile "gotohttp_x64.zip"

    - name: 解压 GotoHTTP
      run: |
        Expand-Archive -Path "gotohttp_x64.zip" -DestinationPath "gotohttp"

    - name: 启动 GotoHTTP 并提取设备码
      run: |
        $exePath = Resolve-Path ".\gotohttp\GotoHTTP_x64.exe"
        $outputFile = "$env:TEMP\gotohttp_output.txt"

        # 启动 GotoHTTP 并写入标准输出文件
        Start-Process -FilePath $exePath `
                      -ArgumentList "-quiet -password 123456" `
                      -RedirectStandardOutput $outputFile `
                      -WindowStyle Hidden

        Start-Sleep -Seconds 5  # 等待输出完成

        # 读取输出
        if (Test-Path $outputFile) {
          $content = Get-Content $outputFile -Raw
          Write-Output "✅ GotoHTTP 启动输出如下："
          Write-Output $content

          if ($content -match "This device ID:\s*(\w+)") {
              $deviceId = $matches[1]
              Write-Output "-----------------------------"
              Write-Output "🎯 远程地址：https://www.gotohttp.com/"
              Write-Output "🔑 设备码：$deviceId"
              Write-Output "🔐 密码：123456"
              Write-Output "-----------------------------"
          } else {
              Write-Output "❌ 未能提取设备码，输出中未发现匹配行。"
          }
        } else {
          Write-Output "❌ 输出文件不存在，GotoHTTP 未输出任何内容。"
        }
