name: Start GotoHTTP on Windows

on:
  workflow_dispatch:

jobs:
  run-gotohttp:
    runs-on: windows-latest

    steps:
    - name: 下载 GotoHTTP zip 包
      run: |
        Invoke-WebRequest -Uri "https://www.gotohttp.com/gotohttp_x64.zip" -OutFile "gotohttp_x64.zip"

    - name: 解压 GotoHTTP
      run: |
        Expand-Archive -Path "gotohttp_x64.zip" -DestinationPath "gotohttp"

    - name: 启动 GotoHTTP 并提取设备码
      run: |
        $exePath = Resolve-Path ".\gotohttp\GotoHTTP_x64.exe"
        $output = & $exePath -quiet -password 123456
        Write-Output "✅ GotoHTTP 启动输出："
        Write-Output $output

        # 提取设备码
        $deviceIdLine = $output | Select-String "This device ID:"
        if ($deviceIdLine -match "This device ID:\s*(\w+)")
        {
            $deviceId = $matches[1]
            Write-Output "-----------------------------"
            Write-Output "🎯 远程地址：https://www.gotohttp.com/"
            Write-Output "🔑 设备码：$deviceId"
            Write-Output "🔐 密码：123456"
            Write-Output "-----------------------------"
        }
        else
        {
            Write-Output "❌ 未能提取设备码，可能 GotoHTTP 未正确启动或输出格式变化。"
        }
